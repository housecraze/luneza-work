<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile Manager</title>
  <style>
    button, input, label {
        touch-action: manipulation;
      }   
    html, body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
      background: #90D5FF;
      color: #333;
      touch-action: manipulation;
    }
    button {
      padding: 10px 14px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(to bottom, #ffffff, #dbeaf5);
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
      cursor: pointer;
      flex: 1 1 40%;
      margin: 5px;
    }
    button:hover {
      background: #cce0f2;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-height: 80vh;
      overflow-y: auto;
      width: 95%;
      position: relative;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }
    table th {
      background: #f0f4f8;
    }
    #toast {
      visibility: hidden;
      min-width: 200px;
      background: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 10px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
    }
    #toast.show {
      visibility: visible;
      animation: fadein 0.3s, fadeout 0.5s 2s;
    }
    @keyframes fadein {
      from { bottom: 20px; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }
    @keyframes fadeout {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 20px; opacity: 0; }
    }
  </style>
</head>
<body>
   <div id="buttonContainer" style="display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-bottom:10px;">
    <button onclick="prevProfile(); isLocated(false)">‚¨ÖÔ∏è Prev</button>
    <button onclick="nextProfile(); isLocated(false)">Next ‚û°Ô∏è</button>
    <button onclick="goToFirstProfile(); isLocated(false)">üîÅ First </button>
    <button onclick="preloadSheets(); isLocated(false)">üîÑ Refresh</button>
  </div>
  <div style="background:white; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px;">
    <h2 style="margin:0 0 8px;">üë§ Current Profile</h2>
    <div><strong>Username:</strong> <span id="username">-</span></div>
    <div><strong>Location:</strong> <span id="location">-</span></div>
    <div><strong>Container ID:</strong> <span id="container">-</span></div>
  </div>
  <div id="buttonContainer" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:16px;">
    <button onclick="showModal('profileModal')">üìÑ Show Accounts</button>
    <button onclick="showModal('postsModal')">üìù Show Posts</button>
    <button onclick="pickRandom('Caption'); openThreads()">üñä Pick Caption</button>
    <button onclick="pickTodayPost(); openThreads()">üìÖ Pick Post</button>
    <button onclick="pickRandom('Reply'); openThreads()">üí¨ Pick Reply</button>
    <button onclick="pickRandom('Comments'); openThreads()">üí≠ Pick Comment</button>
  </div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button onclick="hideModal('profileModal')" style="position:absolute; top:10px; left:10px; background:#ffdddd; border:none; border-radius:6px; padding:4px 10px;">‚ùå</button>
      <h3 style="margin-top:0;">üìÑ Accounts Sheet</h3>
      <table id="profileTable"></table>
    </div>
  </div>

  <div id="postsModal" class="modal">
    <div class="modal-content">
      <button onclick="hideModal('postsModal')" style="position:absolute; top:10px; left:10px; background:#ffdddd; border:none; border-radius:6px; padding:4px 10px;">‚ùå</button>
      <h3 style="margin-top:0;">üìù Posts Sheet</h3>
      <table id="postsTable"></table>
    </div>
  </div>

  <div id="toast"></div>
  <script>
    const sheetUrl = 'https://script.google.com/macros/s/AKfycbyPp0bLsTb8bQ5qWM6VisKxR_Eu2eZp8Il3DzD7EiFt0kSdBIDRqxKdnf71-pult4Sj/exec';
    let profiles = [], currentProfile = 0, located = false;
    let sheetCache = {}, pickedPostIndexes = {};

    // List of ThreadContainers (dynamically generated from 1 to 300)
    const threadContainers = Array.from({length: 300}, (_, i) => `Threads${i+1}`);

    // Function to run the matching Shortcut based on Container ID number
    function runContainerShortcut() {
      const containerId = document.getElementById('container').innerText.trim();
      const containerNumber = parseInt(containerId, 10);
      const matchingThread = threadContainers.find(thread => {
        const threadNumber = parseInt(thread.replace('Threads', ''), 10);
        return threadNumber === containerNumber;
      });

      if (matchingThread) {
        const shortcutUrl = `shortcuts://run-shortcut?name=${matchingThread}`;
        window.location.href = shortcutUrl;
      } else {
        console.log('No matching ThreadContainer found for Container ID:', containerId);
      }
    }

    async function fetchSheet(sheetName) {
      if (sheetCache[sheetName]) return sheetCache[sheetName];
      const res = await fetch(`${sheetUrl}?sheet=${sheetName}`);
      if (!res.ok) throw new Error("Failed to fetch " + sheetName);
      const data = await res.json();
      sheetCache[sheetName] = data;
      return data;
    }

    async function preloadSheets() {
      try {
        setButtonsDisabled(true);
        showToast("Refreshing data...");

        sheetCache = {};
        const savedIndex = parseInt(localStorage.getItem('lastProfileIndex')) || 0;

        profiles = await fetchSheet('Accounts');
        sheetCache['Accounts'] = profiles;
        sheetCache['Posts'] = await fetchSheet('Posts');
        sheetCache['Reply'] = await fetchSheet('Reply');
        sheetCache['Comments'] = await fetchSheet('Comments');
        sheetCache['Caption'] = await fetchSheet('Caption');

        showToast("Sheets refreshed!");
        displayProfile(savedIndex);
        runContainerShortcut(); // Run Shortcut after data refresh
      } catch (e) {
        showToast("Refresh failed");
      } finally {
        setButtonsDisabled(false);
      }
    }

    function displayProfile(index) {
      if (profiles.length === 0) return;
      currentProfile = (index + profiles.length) % profiles.length;
      localStorage.setItem('lastProfileIndex', currentProfile);

      const profile = profiles[currentProfile];
      document.getElementById('username').textContent = profile.username;
      document.getElementById('location').textContent = profile.location;
      document.getElementById('container').textContent = profile.container;
      runContainerShortcut(); // Run Shortcut after profile display
    }

    function nextProfile() { displayProfile(currentProfile + 1); }
    function prevProfile() { displayProfile(currentProfile - 1); }
    function goToFirstProfile() { displayProfile(0); }

    function showModal(id) {
      if (id === 'profileModal') loadAccounts();
      if (id === 'postsModal') loadPosts();
      document.getElementById(id).style.display = 'flex';
    }

    function hideModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    async function loadAccounts() {
      try {
        const accounts = await fetchSheet('Accounts');
        const table = document.getElementById("profileTable");
        table.innerHTML = '<tr><th>Username</th><th>Location</th><th>Container ID</th></tr>' +
          accounts.map(p => `<tr><td>${p.username}</td><td>${p.location}</td><td>${p.container}</td></tr>`).join('');
      } catch (e) {
        showToast("Failed to load accounts");
      }
    }

    async function loadPosts() {
      try {
        const posts = await fetchSheet('Posts');
        const table = document.getElementById("postsTable");
        const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        table.innerHTML = '<tr>' + days.map(d => `<th>${d}</th>`).join('') + '</tr>' +
          posts.map(row => `<tr>` + days.map(day => `<td>${row[day] || ''}</td>`).join('') + '</tr>').join('');
      } catch (e) {
        showToast("Failed to load posts");
      }
    }

    function pickRandom(sheetName) {
      showToast(`Copying from ${sheetName}...`);
      fetchSheet(sheetName).then(data => {
        const choice = data[Math.floor(Math.random() * data.length)];
        let value = Object.values(choice)[0];

        const loc = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || "";
        value = value.replace(/\(loc\)/gi, loc);

        navigator.clipboard.writeText(value);
        showToast(`${sheetName} copied!`);
      }).catch(() => showToast(`Failed to load ${sheetName}`));
    }

    async function pickTodayPost() {
      try {
        showToast("Picking today's post...");
        const posts = await fetchSheet('Posts');
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        const today = days[new Date().getDay()];
        const username = profiles[currentProfile]?.username;

        const todayPosts = posts
          .map((row, index) => ({ index, text: row[today] }))
          .filter(p => p.text?.trim());

        if (!pickedPostIndexes[username]) pickedPostIndexes[username] = {};
        if (!pickedPostIndexes[username][today]) pickedPostIndexes[username][today] = [];
        const unused = todayPosts.filter(p => !pickedPostIndexes[username][today].includes(p.index));

        if (unused.length === 0) {
          pickedPostIndexes[username][today] = [];
          showToast("All posts used for this account, restarting pool");
          return pickTodayPost();
        }

        const selected = unused[Math.floor(Math.random() * unused.length)];
        pickedPostIndexes[username][today].push(selected.index);

        const location = profiles[currentProfile]?.location || profiles[currentProfile]?.Location || "";
        const finalText = selected.text.replace(/\(loc\)/gi, location);

        await navigator.clipboard.writeText(finalText);
        showToast("Post copied with location!");
      } catch (e) {
        showToast("Error picking post");
      }
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "show";
      setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
    }

    function searchLocation() {
      const location = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || '';
      if (!location) {
        showToast("Location not found for this profile.");
        return;
      }
      if (located) {
        openThreads();
        return;
      }
      const query = encodeURIComponent(location);
      const url = `https://www.threads.com/search?q=${query}&serp_type=default&hl=en`;
      window.open(url, '_blank');
    }

    function isLocated(location) {
      located = location;
    }

    function openThreads() {
      window.open(`https://threads.com/`, "_blank");
    }

    function setButtonsDisabled(disabled) {
      const buttons = document.querySelectorAll('#buttonContainer button');
      buttons.forEach(btn => btn.disabled = disabled);
    }

    // Run Shortcut on page load
    window.onload = function() {
      preloadSheets();
      runContainerShortcut();
    };

    // Run Shortcut on DOM content loaded
    document.addEventListener('DOMContentLoaded', runContainerShortcut);
  </script>
</body>
</html>
